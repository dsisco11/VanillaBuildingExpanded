name: Build and Package Mod

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  release:
    types: [ published ]
  workflow_dispatch:
    inputs:
      vs_version:
        description: 'VintageStory version to build against'
        required: false
        default: '1.21.5'
        type: string

env:
  DOTNET_VERSION: '8.0.x'
  VS_VERSION: ${{ inputs.vs_version || '1.21.5' }}
  PROJECT_NAME: 'VanillaBuildingExpanded'

jobs:
  # ============================================
  # Job 1: Build and Test
  # ============================================
  build-test:
    runs-on: ubuntu-latest
    outputs:
      mod_id: ${{ steps.modinfo.outputs.mod_id }}
      mod_version: ${{ steps.modinfo.outputs.mod_version }}
      mod_name: ${{ steps.modinfo.outputs.mod_name }}
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Setup VintageStory Server
      uses: ./.github/actions/setup-vs-server
      with:
        vs-version: ${{ env.VS_VERSION }}

    - name: Cache NuGet packages
      uses: actions/cache@v4
      with:
        path: ~/.nuget/packages
        key: nuget-${{ runner.os }}-${{ hashFiles('**/*.csproj') }}
        restore-keys: nuget-${{ runner.os }}-

    - name: Restore dependencies
      run: dotnet restore

    - name: Build
      run: dotnet build --configuration Release --no-restore

    - name: Test
      run: dotnet test --configuration Release --no-build --verbosity normal

    - name: Get mod info
      id: modinfo
      run: |
        MOD_ID=$(jq -r '.modid' ${{ env.PROJECT_NAME }}/modinfo.json)
        MOD_VERSION=$(jq -r '.version' ${{ env.PROJECT_NAME }}/modinfo.json)
        MOD_NAME=$(jq -r '.name' ${{ env.PROJECT_NAME }}/modinfo.json)
        echo "mod_id=$MOD_ID" >> $GITHUB_OUTPUT
        echo "mod_version=$MOD_VERSION" >> $GITHUB_OUTPUT
        echo "mod_name=$MOD_NAME" >> $GITHUB_OUTPUT
        echo "Built: $MOD_NAME v$MOD_VERSION"

  # ============================================
  # Job 2: Package (Cake Build)
  # ============================================
  package:
    needs: build-test
    runs-on: ubuntu-latest
    outputs:
      mod_id: ${{ steps.modinfo.outputs.mod_id }}
      mod_version: ${{ steps.modinfo.outputs.mod_version }}
      mod_name: ${{ steps.modinfo.outputs.mod_name }}
      artifact_name: ${{ steps.modinfo.outputs.artifact_name }}
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Required for semantic-version to access tag history

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Setup VintageStory Server
      uses: ./.github/actions/setup-vs-server
      with:
        vs-version: ${{ env.VS_VERSION }}

    - name: Cache NuGet packages
      uses: actions/cache@v4
      with:
        path: ~/.nuget/packages
        key: nuget-${{ runner.os }}-${{ hashFiles('**/*.csproj') }}
        restore-keys: nuget-${{ runner.os }}-

    - name: Compute version from git tags
      id: version
      uses: paulhatch/semantic-version@v5.4.0
      with:
        tag_prefix: "v"
        major_pattern: "(MAJOR)"
        minor_pattern: "(MINOR)"
        bump_each_commit: false

    - name: Determine mod version
      id: mod_version
      run: |
        # Base version from semantic-version (next patch after latest tag)
        BASE="${{ steps.version.outputs.major }}.${{ steps.version.outputs.minor }}.${{ steps.version.outputs.patch }}"
        
        if [[ "${{ github.event_name }}" == "release" ]]; then
          # For releases, use exact tag version
          RELEASE_VERSION="${{ github.ref_name }}"
          COMPUTED_VERSION="${RELEASE_VERSION#v}"
          echo "Release event: using exact tag version"
        elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
          # For PRs, use -pre suffix
          COMPUTED_VERSION="${BASE}-pre.${{ github.run_number }}"
          echo "PR event: using pre-release version"
        else
          # For push/workflow_dispatch, use -dev suffix
          COMPUTED_VERSION="${BASE}-dev.${{ github.run_number }}"
          echo "Push/dispatch event: using dev version"
        fi
        
        echo "Computed version: $COMPUTED_VERSION"
        echo "version=$COMPUTED_VERSION" >> $GITHUB_OUTPUT

    - name: Update modinfo.json version
      run: |
        jq --arg version "${{ steps.mod_version.outputs.version }}" '.version = $version' ${{ env.PROJECT_NAME }}/modinfo.json > tmp.json
        mv tmp.json ${{ env.PROJECT_NAME }}/modinfo.json
        echo "Updated modinfo.json:"
        cat ${{ env.PROJECT_NAME }}/modinfo.json

    - name: Restore dependencies
      run: dotnet restore

    - name: Run CakeBuild (Package)
      run: dotnet run --project CakeBuild/CakeBuild.csproj

    - name: Get mod info
      id: modinfo
      run: |
        MOD_ID=$(jq -r '.modid' ${{ env.PROJECT_NAME }}/modinfo.json)
        MOD_VERSION=$(jq -r '.version' ${{ env.PROJECT_NAME }}/modinfo.json)
        MOD_NAME=$(jq -r '.name' ${{ env.PROJECT_NAME }}/modinfo.json)
        ARTIFACT_NAME="${MOD_ID}_${MOD_VERSION}"
        echo "mod_id=$MOD_ID" >> $GITHUB_OUTPUT
        echo "mod_version=$MOD_VERSION" >> $GITHUB_OUTPUT
        echo "mod_name=$MOD_NAME" >> $GITHUB_OUTPUT
        echo "artifact_name=$ARTIFACT_NAME" >> $GITHUB_OUTPUT
        echo "Packaged: $MOD_NAME v$MOD_VERSION"

    - name: Upload mod artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ steps.modinfo.outputs.artifact_name }}
        path: Releases/*.zip
        retention-days: 30

  # ============================================
  # Job 3: Release (Attach artifacts to GitHub Release)
  # ============================================
  # Note: Version is derived from the latest release tag during package job.
  # - Release events: exact tag version (e.g., 1.2.3)
  # - Push/dispatch: incremented patch + dev suffix (e.g., 1.2.4-dev.42)
  # - Pull requests: incremented patch + pre suffix (e.g., 1.2.4-pre.43)
  release:
    needs: package
    runs-on: ubuntu-latest
    if: github.event_name == 'release'
    
    steps:
    - name: Download artifact
      uses: actions/download-artifact@v4
      with:
        name: ${{ needs.package.outputs.artifact_name }}
        path: ./release-artifacts

    - name: Attach artifacts to GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        files: ./release-artifacts/*.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
