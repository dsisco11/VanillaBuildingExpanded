name: Build and Package Mod

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  release:
    types: [ published ]
  workflow_dispatch:
    inputs:
      vs_version:
        description: 'VintageStory version to build against'
        required: false
        default: '1.21.5'
        type: string

env:
  DOTNET_VERSION: '8.0.x'
  VS_VERSION: ${{ inputs.vs_version || '1.21.5' }}
  PROJECT_NAME: 'VanillaBuildingExpanded'

jobs:
  # ============================================
  # Job 1: Build and Test
  # ============================================
  build-test:
    runs-on: ubuntu-latest
    outputs:
      mod_id: ${{ steps.modinfo.outputs.mod_id }}
      mod_version: ${{ steps.modinfo.outputs.mod_version }}
      mod_name: ${{ steps.modinfo.outputs.mod_name }}
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Setup VintageStory Server
      uses: ./.github/actions/setup-vs-server
      with:
        vs-version: ${{ env.VS_VERSION }}

    - name: Cache NuGet packages
      uses: actions/cache@v4
      with:
        path: ~/.nuget/packages
        key: nuget-${{ runner.os }}-${{ hashFiles('**/*.csproj') }}
        restore-keys: nuget-${{ runner.os }}-

    - name: Restore dependencies
      run: dotnet restore

    - name: Build
      run: dotnet build --configuration Release --no-restore

    - name: Test
      run: dotnet test --configuration Release --no-build --verbosity normal

    - name: Get mod info
      id: modinfo
      run: |
        MOD_ID=$(jq -r '.modid' ${{ env.PROJECT_NAME }}/modinfo.json)
        MOD_VERSION=$(jq -r '.version' ${{ env.PROJECT_NAME }}/modinfo.json)
        MOD_NAME=$(jq -r '.name' ${{ env.PROJECT_NAME }}/modinfo.json)
        echo "mod_id=$MOD_ID" >> $GITHUB_OUTPUT
        echo "mod_version=$MOD_VERSION" >> $GITHUB_OUTPUT
        echo "mod_name=$MOD_NAME" >> $GITHUB_OUTPUT
        echo "Built: $MOD_NAME v$MOD_VERSION"

  # ============================================
  # Job 2: Package (Cake Build)
  # ============================================
  package:
    needs: build-test
    runs-on: ubuntu-latest
    outputs:
      mod_id: ${{ steps.modinfo.outputs.mod_id }}
      mod_version: ${{ steps.modinfo.outputs.mod_version }}
      mod_name: ${{ steps.modinfo.outputs.mod_name }}
      artifact_name: ${{ steps.modinfo.outputs.artifact_name }}
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Setup VintageStory Server
      uses: ./.github/actions/setup-vs-server
      with:
        vs-version: ${{ env.VS_VERSION }}

    - name: Cache NuGet packages
      uses: actions/cache@v4
      with:
        path: ~/.nuget/packages
        key: nuget-${{ runner.os }}-${{ hashFiles('**/*.csproj') }}
        restore-keys: nuget-${{ runner.os }}-

    - name: Update version from release tag
      if: github.event_name == 'release'
      run: |
        # Extract version from tag (strip 'v' prefix)
        RELEASE_VERSION="${{ github.ref_name }}"
        RELEASE_VERSION="${RELEASE_VERSION#v}"
        echo "Updating modinfo.json version to: $RELEASE_VERSION"
        
        # Update modinfo.json with new version
        jq --arg version "$RELEASE_VERSION" '.version = $version' ${{ env.PROJECT_NAME }}/modinfo.json > tmp.json
        mv tmp.json ${{ env.PROJECT_NAME }}/modinfo.json
        
        # Show updated content
        echo "Updated modinfo.json:"
        cat ${{ env.PROJECT_NAME }}/modinfo.json

    - name: Restore dependencies
      run: dotnet restore

    - name: Run CakeBuild (Package)
      run: dotnet run --project CakeBuild/CakeBuild.csproj

    - name: Get mod info
      id: modinfo
      run: |
        MOD_ID=$(jq -r '.modid' ${{ env.PROJECT_NAME }}/modinfo.json)
        MOD_VERSION=$(jq -r '.version' ${{ env.PROJECT_NAME }}/modinfo.json)
        MOD_NAME=$(jq -r '.name' ${{ env.PROJECT_NAME }}/modinfo.json)
        ARTIFACT_NAME="${MOD_ID}_${MOD_VERSION}"
        echo "mod_id=$MOD_ID" >> $GITHUB_OUTPUT
        echo "mod_version=$MOD_VERSION" >> $GITHUB_OUTPUT
        echo "mod_name=$MOD_NAME" >> $GITHUB_OUTPUT
        echo "artifact_name=$ARTIFACT_NAME" >> $GITHUB_OUTPUT
        echo "Packaged: $MOD_NAME v$MOD_VERSION"

    - name: Upload mod artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ steps.modinfo.outputs.artifact_name }}
        path: Releases/*.zip
        retention-days: 30

  # ============================================
  # Job 3: Release (Attach artifacts to GitHub Release)
  # ============================================
  # Note: Version is injected from release tag during package job.
  # The release tag (vX.Y.Z) is the source of truth for versioning.
  # modinfo.json in the repo can be updated manually before release or left as-is.
  release:
    needs: package
    runs-on: ubuntu-latest
    if: github.event_name == 'release'
    
    steps:
    - name: Download artifact
      uses: actions/download-artifact@v4
      with:
        name: ${{ needs.package.outputs.artifact_name }}
        path: ./release-artifacts

    - name: Attach artifacts to GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        files: ./release-artifacts/*.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
